(()=>{"use strict";var e=[,(t,e,i)=>{i.r(e),i.d(e,{CurvyWallsToolBar:()=>CurvyWallsToolBar});var n=i(2),o=i(4),s=i(3);class CurvyWallsToolBar extends Application{constructor(t){super(t),this._closing=!1,this._tools={beziercube:{title:"df-curvy-walls.cubic",icon:"fas fa-bezier-curve",isActive:function(){return n.CurvyWallToolManager.instance.mode==n.Mode.Cube},onClick:function(){return n.CurvyWallToolManager.instance.mode=this.isActive()?n.Mode.None:n.Mode.Cube}},bezierquad:{title:"df-curvy-walls.quadratic",icon:"fas fa-project-diagram",isActive:function(){return n.CurvyWallToolManager.instance.mode==n.Mode.Quad},onClick:function(){return n.CurvyWallToolManager.instance.mode=this.isActive()?n.Mode.None:n.Mode.Quad}},beziercirc:{title:"df-curvy-walls.circle",icon:"fas fa-circle",isActive:function(){return n.CurvyWallToolManager.instance.mode==n.Mode.Circ},onClick:function(){return n.CurvyWallToolManager.instance.mode=this.isActive()?n.Mode.None:n.Mode.Circ}},bezierrect:{title:"df-curvy-walls.rectangle",icon:"fas fa-vector-square",isActive:function(){return n.CurvyWallToolManager.instance.mode==n.Mode.Rect},onClick:function(){return n.CurvyWallToolManager.instance.mode=this.isActive()?n.Mode.None:n.Mode.Rect}}},this._generalControls={increment:{title:"df-curvy-walls.increment",icon:"fas fa-plus",onClick:()=>n.CurvyWallToolManager.instance.segments++},decrement:{title:"df-curvy-walls.decrement",icon:"fas fa-minus",onClick:()=>n.CurvyWallToolManager.instance.segments--},apply:{title:"df-curvy-walls.apply",icon:"fas fa-check",class:"apply",onClick:n.CurvyWallToolManager.instance.apply.bind(n.CurvyWallToolManager.instance)},cancel:{title:"df-curvy-walls.cancel",icon:"fas fa-times",class:"cancel",onClick:n.CurvyWallToolManager.instance.clearTool.bind(n.CurvyWallToolManager.instance)}},this._placementControls={pointconstruct:{title:"df-curvy-walls.trace_curve_with_points",icon:"fas fa-route",toggleable:!0,isActive:()=>n.CurvyWallToolManager.instance.currentlyMappingPoints,onClick:()=>{n.CurvyWallToolManager.instance.togglePointMapping(),this.render(!1)}},applyplacement:{title:"df-curvy-walls.pointmapapply",icon:"fas fa-check",class:"apply",onClick:()=>{n.CurvyWallToolManager.instance.applyPointMapping()}}},n.CurvyWallToolManager.instance.setModeListener((()=>{this._closing?this._closing=!1:this.render(!1)}))}static get defaultOptions(){return mergeObject(super.defaultOptions,{popOut:!1,template:"modules/df-curvy-walls/templates/curvy-walls-controls.hbs"})}getData(){var t;const e=n.CurvyWallToolManager.instance.mode!=n.Mode.None&&n.CurvyWallToolManager.instance.activeTool.mode!=s.ToolMode.NotPlaced,i=null===(t=n.CurvyWallToolManager.instance.activeTool)||void 0===t?void 0:t.getTools(),o=[{name:"pointconstruct",title:this._placementControls.pointconstruct.title,icon:this._placementControls.pointconstruct.icon,class:this._placementControls.pointconstruct.class,toggleable:!0,isActive:this._placementControls.pointconstruct.isActive()}];n.CurvyWallToolManager.instance.currentlyMappingPoints&&n.CurvyWallToolManager.instance.canApplyPointMapping&&o.push({name:"applyplacement",title:this._placementControls.applyplacement.title,icon:this._placementControls.applyplacement.icon,class:this._placementControls.applyplacement.class});return{tools:Object.keys(this._tools).map((t=>({name:t,title:this._tools[t].title,icon:this._tools[t].icon,toggleable:!0,isActive:this._tools[t].isActive()}))),general:e?Object.keys(this._generalControls).map((t=>({name:t,title:this._generalControls[t].title,icon:this._generalControls[t].icon,class:this._generalControls[t].class}))):[n.Mode.Quad,n.Mode.Circ,n.Mode.Rect].includes(n.CurvyWallToolManager.instance.mode)?o:[],controls:e&&i?Object.keys(i).map((t=>({name:t,title:i[t].title,icon:i[t].icon,class:i[t].class,toggleable:i[t].toggleable,isActive:i[t].toggleable?i[t].isActive():void 0}))):[]}}activateListeners(t){if(void 0!==window.buttonOverflow){const align=()=>{const e=$("ol#controls").height(),i=$('ol#controls>li[data-control="walls"]>ol').height(),n=document.querySelector("ol#controls").childElementCount,o=document.querySelector('ol#controls>li[data-control="walls"]>ol').childElementCount,s=46*Math.ceil((n-(window.buttonOverflow.hiddenButtons||0))/e*46)+10,l=46*Math.ceil(o/i*46);t.css("left",`${s+l}px`)};window.addEventListener("resize",align),align()}t.find("li").on("click",(t=>{var e;const i=$(t.currentTarget).attr("data-tool"),o=this._tools[i];if(void 0!==o)return void o.onClick();const s=this._generalControls[i];void 0!==s&&s.onClick();const l=this._placementControls[i];void 0!==l&&l.onClick();const r=null===(e=n.CurvyWallToolManager.instance.activeTool)||void 0===e?void 0:e.getTools()[i];void 0!==r&&(r.toggleable?r.onClick(!r.isActive()):r.onClick()),this.render(!1)}))}close(t){return o.default.get(CurvyWallsToolBar.PREF_PRESERVE)||(this._closing=!0,n.CurvyWallToolManager.instance.mode=n.Mode.None),super.close(t)}}CurvyWallsToolBar.PREF_PRESERVE="preserve-tool"},(t,e,i)=>{i.r(e),i.d(e,{Mode:()=>n,CurvyWallToolManager:()=>CurvyWallToolManager});var n,o=i(3),s=i(5),l=i(7),r=i(8),a=i(10),c=i(11),h=i(4);!function(t){t[t.None=0]="None",t[t.Cube=1]="Cube",t[t.Quad=2]="Quad",t[t.Circ=3]="Circ",t[t.Rect=4]="Rect"}(n||(n={}));const d={};d[n.None]="undefined",d[n.Cube]="beziercube",d[n.Quad]="bezierquad",d[n.Circ]="beziercirc",d[n.Rect]="bezierrect";class WallPool{static acquire(t){var e;const i=null!==(e=this.walls.pop())&&void 0!==e?e:new Wall(new WallDocument(t,{parent:canvas.scene}));return i.data=t,i}static release(t){this.walls.push(t)}}WallPool.walls=[];class CurvyWallToolManager{constructor(){this._mode=n.None,this.walls=[],this.currentHandler=null,this._activeTool=null,this._modeListener=null,this._ignoreNextToolModeChange=!1,this._previousToolData=new Map([[n.Cube,{l1:[-100,0],l2:[100,0],c1:[-100,-132],c2:[100,-132]}],[n.Quad,{l1:[-100,0],l2:[100,0],c:[0,-132]}],[n.Circ,{l1:[-100,-100],l2:[100,100],a1:0,a2:0}],[n.Rect,{l1:[-100,-100],l2:[100,100],t:1,r:1,b:1,l:1}]]),this._pointMapper=new c.default,this._inPointMapMode=!1,this.graphicsContext=new PIXI.Graphics(null)}get segments(){return this._activeTool.segments}set segments(t){this._activeTool.segments=Math.clamped(t,1,64),this.mode!=n.None&&this.render()}get activeTool(){return this._activeTool}get currentlyMappingPoints(){return this._inPointMapMode}static get instance(){return this._instance||(this._instance=new this)}get mode(){return this._mode}set mode(t){var e,i,c;if(this._mode!==t){switch(this._ignoreNextToolModeChange=(null===(e=this.activeTool)||void 0===e?void 0:e.mode)!==o.ToolMode.NotPlaced,this.clearTool(),this._inPointMapMode&&this.togglePointMapping(),this._mode=t,this._inPointMapMode&&(this._pointMapper.points=[]),t){case n.None:this._activeTool=null;break;case n.Cube:this._activeTool=new r.default;break;case n.Quad:this._activeTool=new a.default;break;case n.Circ:this._activeTool=new s.default;break;case n.Rect:this._activeTool=new l.default}null===(i=this._activeTool)||void 0===i||i.setModeListener((t=>{this._ignoreNextToolModeChange?this._ignoreNextToolModeChange=!1:null!==this._modeListener&&this._modeListener(this._mode,t)})),null!==this._modeListener&&this._modeListener(t,null===(c=this.activeTool)||void 0===c?void 0:c.mode)}}setModeListener(t){this._modeListener=t}async apply(){this.activeTool&&this.activeTool.mode==o.ToolMode.Placed&&(await game.scenes.viewed.createEmbeddedDocuments("Wall",this.walls.map((t=>t.data))),this.clearTool())}clearTool(){this._activeTool?(this._activeTool.clearTool(),this.walls=[],this.wallsLayer.preview.removeChildren(),this.render()):this._ignoreNextToolModeChange=!1}togglePointMapping(){this._inPointMapMode=!this._inPointMapMode,this._inPointMapMode?(this._pointMapper.points=[],ui.notifications.info(game.i18n.localize(this._pointMapper.getTooltipMessage()),{permanent:!0})):(ui.notifications.active.forEach((t=>t.remove())),ui.notifications.active=[]),this.render()}get canApplyPointMapping(){return this._pointMapper.hasEnoughData()}applyPointMapping(){this._inPointMapMode&&(this._inPointMapMode=!1,this._pointMapper.bindData(this._activeTool),this._activeTool.setMode(o.ToolMode.Placed),ui.notifications.active.forEach((t=>t.remove())),ui.notifications.active=[],this.render())}static _onClickLeft(t,e){const i=CurvyWallToolManager.instance;if(i._inPointMapMode){if(!i._pointMapper.checkPointForClick(e.data.origin,e))return;return i._pointMapper.hasEnoughData()&&i._modeListener(i.mode,o.ToolMode.NotPlaced),void i.render()}if(i.mode==n.None||null==i.activeTool)return t(e);i.activeTool.checkPointForClick(e.data.origin,e)?i.render():(e.data.originalEvent.ctrlKey&&(i.activeTool.startedWithCtrlHeld=!0),("ctrl"!==h.default.get(CurvyWallToolManager.PREF_DROP_KEY)||e.data.originalEvent.ctrlKey)&&("alt"!==h.default.get(CurvyWallToolManager.PREF_DROP_KEY)||e.data.originalEvent.altKey)&&(i.activeTool.placeTool(e.data.origin,i._previousToolData.get(i._mode)),i.render()))}static _onDragLeftStart(t,e){const i=CurvyWallToolManager.instance;if(i._inPointMapMode){if(i.currentHandler=i._pointMapper.checkPointForDrag(e.data.origin),null==i.currentHandler)return;return i.currentHandler.start(e.data.origin,e.data.destination,e),void i.render()}if(i.mode==n.None||null==i.activeTool)return t(e);i.currentHandler=i.activeTool.checkPointForDrag(e.data.origin),null!=i.currentHandler&&(i.currentHandler.start(e.data.origin,e.data.destination,e),i.render())}static _onDragLeftMove(t,e){const i=CurvyWallToolManager.instance;if(i.mode==n.None||!i.currentHandler)return t(e);i.activeTool.startedWithCtrlHeld&&!e.data.originalEvent.ctrlKey&&(i.activeTool.startedWithCtrlHeld=!1),i.currentHandler.move(e.data.origin,e.data.destination,e),i.render()}static _onDragLeftDrop(t,e){const i=CurvyWallToolManager.instance;if(i.mode==n.None||!i.currentHandler)return t(e);i.activeTool.startedWithCtrlHeld=!1,i.currentHandler.stop(e.data.origin,e.data.destination,e),i.currentHandler=null,i.render()}static _onDragLeftCancel(t,e){const i=CurvyWallToolManager.instance;if(i.mode==n.None)return t(e);i.currentHandler&&(i.currentHandler.cancel(),i.currentHandler=null,i.render())}static _onClickRight(t,e){const i=CurvyWallToolManager.instance;if(!e.data.originalEvent.ctrlKey||i.mode==n.None)return t(e);i.mode=n.None,i.render()}render(){var t;if(this.wallsLayer.preview.removeChildren(),this.currentlyMappingPoints)return this._pointMapper.clearContext(this.graphicsContext),this.graphicsContext.clear(),this.graphicsContext.removeChildren(),this.wallsLayer.preview.addChild(this.graphicsContext),void this._pointMapper.drawHandles(this.graphicsContext);if(null==this.activeTool)return;const e=null===(t=this.activeTool)||void 0===t?void 0:t.getSegments(this.segments);if(0==e.length)return;this.walls.length;const i=this.wallsLayer._getWallDataFromActiveTool(game.activeTool);for(;this.walls.length>e.length-1;){const t=this.walls.pop();WallPool.release(t),this.wallsLayer.preview.removeChild(t)}if(void 0!==e[0].x){const t=e;for(let e=0;e<t.length-1;e++){const n=duplicate(i);n.c=[t[e].x,t[e].y,t[e+1].x,t[e+1].y],e==this.walls.length?(this.walls.push(WallPool.acquire(n)),this.wallsLayer.preview.addChild(this.walls[e]),this.walls[e].draw()):(this.walls[e].data=n,this.wallsLayer.preview.addChild(this.walls[e]),this.walls[e].refresh())}}else if(void 0!==e[0][0].x){const t=e;if(this.walls.length>t.length){const t=this.walls.pop();WallPool.release(t),this.wallsLayer.preview.removeChild(t)}for(let e=0;e<t.length;e++){const n=duplicate(i);n.c=[t[e][0].x,t[e][0].y,t[e][1].x,t[e][1].y],e==this.walls.length?(this.walls.push(WallPool.acquire(n)),this.wallsLayer.preview.addChild(this.walls[e]),this.walls[e].draw()):(this.walls[e].data=n,this.wallsLayer.preview.addChild(this.walls[e]),this.walls[e].refresh())}}this.activeTool.clearContext(this.graphicsContext),this.graphicsContext.removeChildren().forEach((t=>t.destroy())),this.graphicsContext.clear(),this.graphicsContext.visible=!0,this.wallsLayer.preview.addChild(this.graphicsContext),this.activeTool.drawHandles(this.graphicsContext),this._previousToolData.set(this._mode,this.activeTool.getData())}patchWallsLayer(){this.wallsLayer=canvas.walls;const t="df-curvy-walls";libWrapper.register(t,"WallsLayer.prototype._onClickLeft",CurvyWallToolManager._onClickLeft,"MIXED"),libWrapper.register(t,"WallsLayer.prototype._onDragLeftStart",CurvyWallToolManager._onDragLeftStart,"MIXED"),libWrapper.register(t,"WallsLayer.prototype._onDragLeftMove",CurvyWallToolManager._onDragLeftMove,"MIXED"),libWrapper.register(t,"WallsLayer.prototype._onDragLeftDrop",CurvyWallToolManager._onDragLeftDrop,"MIXED"),libWrapper.register(t,"WallsLayer.prototype._onDragLeftCancel",CurvyWallToolManager._onDragLeftCancel,"MIXED"),libWrapper.register(t,"WallsLayer.prototype._onClickRight",CurvyWallToolManager._onClickRight,"MIXED"),Hooks.on("requestCurvyWallsRedraw",(()=>this.render()))}}CurvyWallToolManager.PREF_DROP_KEY="drop-key"},(t,e,i)=>{i.r(e),i.d(e,{ToolMode:()=>n,BezierTool:()=>BezierTool});var n,o=i(4);!function(t){t[t.NotPlaced=0]="NotPlaced",t[t.Placing=1]="Placing",t[t.Placed=2]="Placed"}(n||(n={}));class BezierTool{constructor(t=10){this._mode=n.NotPlaced,this.lastSegmentFetch=[],this.segments=8,this._modeListener=null,this.startedWithCtrlHeld=!1,this.segments=t}static get HANDLE_RADIUS(){return o.default.get(this.PREF_SMALL_HANDLES)?5:10}static get TEXT_STYLE(){return this.TEXT_STYLE_BASE.fontSize=o.default.get(this.PREF_SMALL_HANDLES)?18:24,this.TEXT_STYLE_BASE}get lineCenter(){return new PIXI.Point(this.lineA.x+(this.lineB.x-this.lineA.x)/2,this.lineA.y+(this.lineB.y-this.lineA.y)/2)}get mode(){return this._mode}setMode(t){this._mode!==t&&(this._mode=t,null!==this._modeListener&&this._modeListener(t))}checkPointForClick(t,e){return!1}clearContext(t){}clearTool(){this.setMode(n.NotPlaced)}setModeListener(t){this._modeListener=t}static createText(t){const e=new PreciseText(t,BezierTool.TEXT_STYLE);return e.anchor.set(.5,.5),e}drawSegmentLabel(t){const e=BezierTool.createText("⊷"+(this.lastSegmentFetch.length-1));e.position=this.lineCenter,t.addChild(e)}drawBoundingBox(t){const e=this.bounds.getRectangle(PIXI.Rectangle.EMPTY);t.beginFill(0,0).lineStyle(BezierTool.LINE_SIZE,15240493,1,.5).drawRoundedRect(e.left-20,e.top-20,e.width+40,e.height+40,20).endFill()}drawHandle(t,e,i){return t.beginFill(e,1).lineStyle(BezierTool.LINE_SIZE,0,1,.5).drawCircle(i.x,i.y,BezierTool.HANDLE_RADIUS).endFill()}static pointNearPoint(t,e,i){const n=t.x-e.x,o=t.y-e.y;return n*n+o*o<=i*i}}BezierTool.PREF_SMALL_HANDLES="BezierTool.SmallHandles",BezierTool.LINE_SIZE=2,BezierTool.TEXT_STYLE_BASE=new PIXI.TextStyle({fontFamily:CONFIG.defaultFontFamily,fontSize:24,fill:"#BBBBBB",stroke:"#111111",strokeThickness:4,dropShadow:!1,dropShadowColor:"#000000",dropShadowBlur:Math.max(Math.round(1.5),2),dropShadowAngle:0,dropShadowDistance:0,padding:1})},(t,e,i)=>{i.r(e),i.d(e,{default:()=>SETTINGS});class SETTINGS{static init(t){this.MOD_NAME=t,String.prototype.localize||(String.prototype.localize=function(){return game.i18n.localize(this.valueOf())})}static register(t,e){game.settings.register(SETTINGS.MOD_NAME,t,e)}static registerMenu(t,e){game.settings.registerMenu(SETTINGS.MOD_NAME,t,e)}static get(t){return game.settings.get(SETTINGS.MOD_NAME,t)}static async set(t,e){return await game.settings.set(SETTINGS.MOD_NAME,t,e)}static default(t){return game.settings.settings.get(SETTINGS.MOD_NAME+"."+t).default}static typeOf(){return Object}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>CircleTool});var n=i(3),o=i(6);const s=n.BezierTool.pointNearPoint,l=2*Math.PI;class InitializerIH extends o.InitializerInputHandler{constructor(t,e,i){super(t,!0,t.lineA,t.lineB,e,i)}}class CircleTool extends n.BezierTool{constructor(){super(...arguments),this.lineA=new PIXI.Point,this.lineB=new PIXI.Point,this.arcHandle=new RotatorHandle(100),this.sliceHandle=new RotatorHandle(75,this.arcHandle),this._tools={ellipseclose:{icon:"fas fa-adjust",title:"df-curvy-walls.ellipse_close",toggleable:!0,isActive:()=>CircleTool.closeLoopIfSliced,onClick:t=>{CircleTool.closeLoopIfSliced=t,Hooks.call("requestCurvyWallsRedraw")}},ellipsefinish:{icon:"fas fa-compress-alt",title:"df-curvy-walls.ellipse_finish_slice",toggleable:!0,isActive:()=>CircleTool.finishSliceIfShort,onClick:t=>{CircleTool.finishSliceIfShort=t,Hooks.call("requestCurvyWallsRedraw")}},ellipseinc:{icon:"dfcw ellipseinc",title:"df-curvy-walls.ellipse_increment",onClick:()=>{CircleTool.snapSetIndex=Math.clamped(CircleTool.snapSetIndex+1,0,CircleTool.ANGLE_SNAP_STEPS.length-1),Hooks.call("requestCurvyWallsRedraw")}},ellipsedec:{icon:"dfcw ellipsedec",title:"df-curvy-walls.ellipse_decrement",onClick:()=>{CircleTool.snapSetIndex=Math.clamped(CircleTool.snapSetIndex-1,0,CircleTool.ANGLE_SNAP_STEPS.length-1),Hooks.call("requestCurvyWallsRedraw")}}}}get handles(){return[this.lineA,this.lineB]}get bounds(){const t=new PIXI.Bounds;return t.addPoint(this.lineA),t.addPoint(this.lineB),t}get polygon(){const t=this.bounds;return new PIXI.Polygon([t.minX,t.minY,t.maxX,t.minY,t.minX,t.maxY,t.maxX,t.maxY])}getTools(){return this._tools}placeTool(t,e){this.lineA.set(e.l1[0]+t.x,e.l1[1]+t.y),this.lineB.set(e.l2[0]+t.x,e.l2[1]+t.y),this.arcHandle.angle=e.a1,this.sliceHandle.angle=e.a2,this.setMode(n.ToolMode.Placed)}getData(){const t=this.lineCenter;return{l1:[this.lineA.x-t.x,this.lineA.y-t.y],l2:[this.lineB.x-t.x,this.lineB.y-t.y],a1:this.arcHandle.angle,a2:this.sliceHandle.angle}}getCenter(){const t=this.bounds,e=t.getRectangle(PIXI.Rectangle.EMPTY),i=e.width/2,n=e.height/2;return new PIXI.Point(t.minX+i,t.minY+n)}createVector(t,e,i){return new PIXI.Point(i.x+Math.cos(t)*e.x,i.y+Math.sin(t)*e.y)}getSegments(t){if(this.mode==n.ToolMode.NotPlaced)return[];const e=this.bounds,i=e.getRectangle(PIXI.Rectangle.EMPTY),o=Math.PI/t,s=new PIXI.Point(i.width/2,i.height/2),r=new PIXI.Point(e.minX+s.x,e.minY+s.y),a=[];let c=l;const h=this.sliceHandle.rawAngle!=l?this.sliceHandle.rawAngle:0;for(;c>=h;)a.push(this.createVector(this.arcHandle.rawAngle+c,s,r)),c-=o,c<1e-10&&c>-1e-10&&(c=0);return CircleTool.finishSliceIfShort&&c!=h&&0!=h&&a.push(this.createVector(this.arcHandle.rawAngle+h,s,r)),CircleTool.closeLoopIfSliced&&0!=h&&a.push(a[0]),this.lastSegmentFetch=a}initialPoints(){return[0,0,0,0,0,0]}drawHandles(t){if(this.mode==n.ToolMode.NotPlaced)return;this.drawBoundingBox(t);const e=this.getCenter(),i=this.arcHandle.getHandlePoint(e),o=this.sliceHandle.getHandlePoint(e);t.beginFill(16755404).lineStyle(n.BezierTool.LINE_SIZE,16755404,1,.5).moveTo(this.lineA.x,this.lineA.y).lineTo(this.lineB.x,this.lineB.y).moveTo(e.x,e.y).lineTo(i.x,i.y).moveTo(e.x,e.y).lineTo(o.x,o.y).endFill(),this.drawSegmentLabel(t);const s=Math.toDegrees(CircleTool.ANGLE_SNAP_STEPS[CircleTool.snapSetIndex]).toFixed(2),l=n.BezierTool.createText(`⇲${s}°   ◶${180/parseFloat(s)}`);l.position.copyFrom(this.lineCenter),l.position.y+=n.BezierTool.TEXT_STYLE.fontSize+4,t.addChild(l),this.drawHandle(t,16729156,this.lineA),this.drawHandle(t,16729156,this.lineB),this.drawHandle(t,4521796,this.arcHandle.getHandlePoint(this.getCenter())),this.drawHandle(t,4474111,this.sliceHandle.getHandlePoint(this.getCenter()))}drawSegmentLabel(t){const e=n.BezierTool.createText("⊷"+(this.lastSegmentFetch.length-1));e.position=this.lineCenter,t.addChild(e)}checkPointForDrag(t){return this.mode==n.ToolMode.NotPlaced?(this.setMode(n.ToolMode.Placing),new InitializerIH(this,(()=>this.setMode(n.ToolMode.Placed)),(()=>this.setMode(n.ToolMode.NotPlaced)))):s(t,this.lineA,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineA,null,this.lineB):s(t,this.lineB,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineB,null,this.lineA):s(t,this.arcHandle.getHandlePoint(this.getCenter()),n.BezierTool.HANDLE_RADIUS)?new PointRotationHandler(this,this.arcHandle,this.getCenter()):s(t,this.sliceHandle.getHandlePoint(this.getCenter()),n.BezierTool.HANDLE_RADIUS)?new PointRotationHandler(this,this.sliceHandle,this.getCenter()):this.polygon.contains(t.x,t.y)?new o.PointArrayInputHandler(this,t,this.handles):null}}CircleTool.ANGLE_SNAP_STEPS=[Math.PI/4,Math.PI/6,Math.PI/12,Math.PI/24,Math.PI/48],CircleTool.snapSetIndex=2,CircleTool.finishSliceIfShort=!0,CircleTool.closeLoopIfSliced=!1;class RotatorHandle{constructor(t,e){this._angle=0,this.length=0,this.length=t,this.magnet=e}get rawAngle(){return this._angle}set rawAngle(t){this._angle=t}get angle(){return this.magnet?this._angle+this.magnet._angle:this._angle}set angle(t){this._angle=this.magnet?t-this.magnet._angle:this._angle=t}getHandlePoint(t){const e=this.magnet?this.magnet._angle:0,i=Math.cos(e+this._angle)*this.length,n=Math.sin(e+this._angle)*this.length;return new PIXI.Point(t.x+i,t.y+n)}}class PointRotationHandler extends o.InputHandler{constructor(t,e,i){super(t),this.arcHandle=e,this.original=this.arcHandle.angle,this.center=i}setAngle(t,e){const i=t.x-this.center.x,n=t.y-this.center.y;let o=Math.atan(n/i);if(i<0?o+=Math.PI:n<0&&(o+=l),this.shouldSnap(e)){const t=CircleTool.ANGLE_SNAP_STEPS[CircleTool.snapSetIndex],e=Math.trunc(o/t);o=o-e*t<t/2?e*t:(e+1)*t}const s=this.arcHandle.magnet?l-this.arcHandle.magnet.rawAngle:0;this.arcHandle.rawAngle=(s+o)%l}start(t,e,i){this.setAngle(e,i)}move(t,e,i){this.setAngle(e,i)}stop(t,e,i){this.setAngle(e,i)}cancel(){this.arcHandle.angle=this.original}}},(t,e,i)=>{i.r(e),i.d(e,{InputHandler:()=>InputHandler,InitializerInputHandler:()=>InitializerInputHandler,PointInputHandler:()=>PointInputHandler,PointArrayInputHandler:()=>PointArrayInputHandler,MagnetPointInputHandler:()=>MagnetPointInputHandler});class InputHandler{constructor(t){this._tool=t}get tool(){return this._tool}static finalPoint(t,e=!0){return canvas.walls._getWallEndpointCoordinates(t,{snap:e})}get walls(){return canvas.walls}shouldSnap(t){const{originalEvent:e}=t.data;return this.walls._forceSnap||!e.shiftKey}getWallEndPoint(t,e){return new PIXI.Point(...this.walls._getWallEndpointCoordinates(t,{snap:e}))}static squarePoint(t,e){const i=Math.max(Math.abs(e.x-t.x),Math.abs(e.y-t.y));return e.x>t.x?e.y<t.y?new PIXI.Point(t.x+i,t.y-i):new PIXI.Point(t.x+i,t.y+i):e.y>t.y?new PIXI.Point(t.x-i,t.y+i):new PIXI.Point(t.x-i,t.y-i)}}class InitializerInputHandler extends InputHandler{constructor(t,e,i,n,o,s){super(t),this.lineA=i,this.lineB=n,this.squaring=e,this.success=o,this.fail=s}start(t,e,i){const n=this.shouldSnap(i);this.lineA.copyFrom(this.getWallEndPoint(t,n)),this.lineB.copyFrom(this.getWallEndPoint(e,n))}move(t,e,i){const n=this.shouldSnap(i),o=this.squaring&&i.data.originalEvent.altKey?InputHandler.squarePoint(t,e):e,s=!this.tool.startedWithCtrlHeld&&i.data.originalEvent.ctrlKey?new PIXI.Point(t.x-(o.x-t.x),t.y-(o.y-t.y)):t;this.lineA.copyFrom(this.getWallEndPoint(s,n)),this.lineB.copyFrom(this.getWallEndPoint(o,n))}stop(t,e,i){const n=this.shouldSnap(i);this.squaring&&i.data.originalEvent.altKey?this.lineB.copyFrom(this.getWallEndPoint(InputHandler.squarePoint(t,e),n)):this.lineB.copyFrom(this.getWallEndPoint(e,n)),this.success()}cancel(){this.fail()}}class PointInputHandler extends InputHandler{constructor(t,e,i=null,n){super(t),this._originalPoint=new PIXI.Point(0,0),this.completion=null,this._originalPoint.copyFrom(e),this._origin=n,this.point=e,this.completion=i}start(t,e,i){this.move(null,e,i)}move(t,e,i){this._origin&&i.data.originalEvent.altKey?this.point.copyFrom(this.getWallEndPoint(InputHandler.squarePoint(this._origin,e),this.shouldSnap(i))):this.point.copyFrom(this.getWallEndPoint(e,this.shouldSnap(i)))}stop(t,e,i){this._origin&&i.data.originalEvent.altKey?this.point.copyFrom(this.getWallEndPoint(InputHandler.squarePoint(this._origin,e),this.shouldSnap(i))):this.point.copyFrom(this.getWallEndPoint(e,this.shouldSnap(i))),null!=this.completion&&this.completion(this)}cancel(){this.point.copyFrom(this._originalPoint),null!=this.completion&&this.completion(this)}}class PointArrayInputHandler extends InputHandler{constructor(t,e,i,n=null){super(t),this.originalPoints=[],i.forEach((t=>this.originalPoints.push(t.clone()))),this.points=i,this._start=e,this.completion=n}moveAll(t,e){const i=new PIXI.Point(t.x-this._start.x,t.y-this._start.y),n=this.shouldSnap(e);let o;this.points.forEach(((t,e)=>{o=this.originalPoints[e],t.copyFrom(this.getWallEndPoint(new PIXI.Point(o.x+i.x,o.y+i.y),n))}))}start(t,e,i){this.moveAll(e,i)}move(t,e,i){this.moveAll(e,i)}stop(t,e,i){this.moveAll(e,i),null!=this.completion&&this.completion(this)}cancel(){this.originalPoints.forEach(((t,e)=>t.copyTo(this.points[e]))),null!=this.completion&&this.completion(this)}}class MagnetPointInputHandler extends InputHandler{constructor(t,e,i,n=null){super(t),this.originalPoint=new PIXI.Point(0,0),this.completion=null,this.originalPoint.copyFrom(e),this.masterPoint=e,this.slavePoint=i,this.offsetX=i.x-e.x,this.offsetY=i.y-e.y,this.completion=n}start(t,e,i){this.move(null,e,i)}move(t,e,i){this.masterPoint.copyFrom(this.getWallEndPoint(e,this.shouldSnap(i))),this.slavePoint.set(this.masterPoint.x+this.offsetX,this.masterPoint.y+this.offsetY)}stop(t,e,i){this.masterPoint.copyFrom(this.getWallEndPoint(e,this.shouldSnap(i))),this.slavePoint.set(this.masterPoint.x+this.offsetX,this.masterPoint.y+this.offsetY),null!=this.completion&&this.completion(this)}cancel(){this.masterPoint.copyFrom(this.originalPoint),this.slavePoint.set(this.masterPoint.x+this.offsetX,this.masterPoint.y+this.offsetY),null!=this.completion&&this.completion(this)}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>RectangleTool});var n=i(3),o=i(6);const s=n.BezierTool.pointNearPoint;class InitializerIH extends o.InitializerInputHandler{constructor(t,e,i){super(t,!0,t.lineA,t.lineB,e,i)}}class RectangleTool extends n.BezierTool{constructor(){super(1),this.lineA=new PIXI.Point,this.lineB=new PIXI.Point,this.lastCount=0,this.topCount=0,this.rightCount=0,this.bottomCount=0,this.leftCount=0,this.buttonRadius=50,this.buttonOffset=15,this.incTop=RectangleTool.createLineLabel("+"),this.decTop=RectangleTool.createLineLabel("-"),this.incRight=RectangleTool.createLineLabel("+"),this.decRight=RectangleTool.createLineLabel("-"),this.incBottom=RectangleTool.createLineLabel("+"),this.decBottom=RectangleTool.createLineLabel("-"),this.incLeft=RectangleTool.createLineLabel("+"),this.decLeft=RectangleTool.createLineLabel("-"),this.textTop=n.BezierTool.createText(""),this.textRight=n.BezierTool.createText(""),this.textBottom=n.BezierTool.createText(""),this.textLeft=n.BezierTool.createText(""),this.incTop.tint=11206468,this.incBottom.tint=11206468,this.incRight.tint=11206468,this.incLeft.tint=11206468,this.decTop.tint=16729156,this.decBottom.tint=16729156,this.decRight.tint=16729156,this.decLeft.tint=16729156,this.textRight.rotation=Math.PI/2,this.textLeft.rotation=-Math.PI/2}get handles(){return[this.lineA,this.lineB]}get bounds(){const t=new PIXI.Bounds;return t.addPoint(this.lineA),t.addPoint(this.lineB),t}get rect(){return new PIXI.Rectangle(this.lineA.x,this.lineA.y,this.lineB.x,this.lineB.y)}static createLineLabel(t){const e=new PreciseText(t,RectangleTool.STYLE);return e.anchor.set(.5,.5),e}clearContext(t){super.clearContext(t),t.removeChild(this.incTop),t.removeChild(this.decTop),t.removeChild(this.incRight),t.removeChild(this.decRight),t.removeChild(this.incBottom),t.removeChild(this.decBottom),t.removeChild(this.incLeft),t.removeChild(this.decLeft),t.removeChild(this.textTop),t.removeChild(this.textRight),t.removeChild(this.textBottom),t.removeChild(this.textLeft)}drawHandles(t){this.mode!=n.ToolMode.NotPlaced&&(this.drawBoundingBox(t),t.beginFill(16755404).lineStyle(n.BezierTool.LINE_SIZE,16755404,1,.5).moveTo(this.lineA.x,this.lineA.y).lineTo(this.lineB.x,this.lineB.y).endFill(),this.drawSegmentLabels(t),this.drawButtons(t),this.drawHandle(t,16729156,this.lineA),this.drawHandle(t,11206468,this.lineB))}drawSegmentLabels(t){this.textTop.text=`⊷${Math.trunc(this.topCount+this.lastCount)}`,this.textRight.text=`⊷${Math.trunc(this.rightCount+this.lastCount)}`,this.textBottom.text=`⊷${Math.trunc(this.bottomCount+this.lastCount)}`,this.textLeft.text=`⊷${Math.trunc(this.leftCount+this.lastCount)}`;const e=this.bounds;this.textTop.position=new PIXI.Point(this.lineCenter.x,e.minY-25),this.textBottom.position=new PIXI.Point(this.lineCenter.x,e.maxY+25),this.textLeft.position=new PIXI.Point(e.minX-25,this.lineCenter.y),this.textRight.position=new PIXI.Point(e.maxX+25,this.lineCenter.y),t.addChild(this.textTop,this.textRight,this.textBottom,this.textLeft)}drawButtons(t){const e=this.lineCenter;this.incTop.position=new PIXI.Point(e.x+this.buttonOffset,e.y-this.buttonRadius),this.decTop.position=new PIXI.Point(e.x-this.buttonOffset,e.y-this.buttonRadius),this.incBottom.position=new PIXI.Point(e.x+this.buttonOffset,e.y+this.buttonRadius),this.decBottom.position=new PIXI.Point(e.x-this.buttonOffset,e.y+this.buttonRadius),this.incLeft.position=new PIXI.Point(e.x-this.buttonRadius,e.y-this.buttonOffset),this.decLeft.position=new PIXI.Point(e.x-this.buttonRadius,e.y+this.buttonOffset),this.incRight.position=new PIXI.Point(e.x+this.buttonRadius,e.y-this.buttonOffset),this.decRight.position=new PIXI.Point(e.x+this.buttonRadius,e.y+this.buttonOffset),t.addChild(this.incTop,this.decTop,this.incRight,this.decRight,this.incBottom,this.decBottom,this.incLeft,this.decLeft)}getSegments(t){if(this.mode==n.ToolMode.NotPlaced)return[];this.lastCount=t;const e=this.bounds,i=e.maxX-e.minX,o=e.maxY-e.minY,s=[];let l=i/(t+this.topCount);for(let i=0;i<t+this.topCount;i++)s.push([new PIXI.Point(e.minX+i*l,e.minY),new PIXI.Point(e.minX+(i+1)*l,e.minY)]);l=o/(t+this.rightCount);for(let i=0;i<t+this.rightCount;i++)s.push([new PIXI.Point(e.maxX,e.minY+i*l),new PIXI.Point(e.maxX,e.minY+(i+1)*l)]);l=i/(t+this.bottomCount);for(let i=0;i<t+this.bottomCount;i++)s.push([new PIXI.Point(e.maxX-i*l,e.maxY),new PIXI.Point(e.maxX-(i+1)*l,e.maxY)]);l=o/(t+this.leftCount);for(let i=0;i<t+this.leftCount;i++)s.push([new PIXI.Point(e.minX,e.maxY-i*l),new PIXI.Point(e.minX,e.maxY-(i+1)*l)]);return this.lastSegmentFetch=s}checkPointForDrag(t){return this.mode==n.ToolMode.NotPlaced?(this.setMode(n.ToolMode.Placing),new InitializerIH(this,(()=>this.setMode(n.ToolMode.Placed)),(()=>this.setMode(n.ToolMode.NotPlaced)))):s(t,this.lineA,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineA,null,this.lineB):s(t,this.lineB,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineB,null,this.lineA):this.rect.contains(t.x,t.y)?new o.PointArrayInputHandler(this,t,this.handles):null}checkPointForClick(t){return s(t,this.incTop.position,2*n.BezierTool.HANDLE_RADIUS)?(this.topCount=Math.clamped(this.topCount+1,-64,64),!0):s(t,this.decTop.position,2*n.BezierTool.HANDLE_RADIUS)?(this.topCount=Math.clamped(this.topCount-1,-64,64),!0):s(t,this.incRight.position,2*n.BezierTool.HANDLE_RADIUS)?(this.rightCount=Math.clamped(this.rightCount+1,-64,64),!0):s(t,this.decRight.position,2*n.BezierTool.HANDLE_RADIUS)?(this.rightCount=Math.clamped(this.rightCount-1,-64,64),!0):s(t,this.incBottom.position,2*n.BezierTool.HANDLE_RADIUS)?(this.bottomCount=Math.clamped(this.bottomCount+1,-64,64),!0):s(t,this.decBottom.position,2*n.BezierTool.HANDLE_RADIUS)?(this.bottomCount=Math.clamped(this.bottomCount-1,-64,64),!0):s(t,this.incLeft.position,2*n.BezierTool.HANDLE_RADIUS)?(this.leftCount=Math.clamped(this.leftCount+1,-64,64),!0):!!s(t,this.decLeft.position,2*n.BezierTool.HANDLE_RADIUS)&&(this.leftCount=Math.clamped(this.leftCount-1,-64,64),!0)}getTools(){return{}}placeTool(t,e){this.lineA.set(e.l1[0]+t.x,e.l1[1]+t.y),this.lineB.set(e.l2[0]+t.x,e.l2[1]+t.y),this.topCount=e.t,this.rightCount=e.r,this.bottomCount=e.b,this.leftCount=e.l,this.setMode(n.ToolMode.Placed)}getData(){const t=this.lineCenter;return{l1:[this.lineA.x-t.x,this.lineA.y-t.y],l2:[this.lineB.x-t.x,this.lineB.y-t.y],t:this.topCount,r:this.rightCount,b:this.bottomCount,l:this.leftCount}}initialPoints(){return[0,0,0,0,0,0]}}RectangleTool.STYLE=new PIXI.TextStyle({fontFamily:CONFIG.defaultFontFamily,fontSize:48,fill:"#BBBBBB",stroke:"#111111",strokeThickness:4,dropShadow:!0,dropShadowColor:"#000000",dropShadowBlur:Math.max(Math.round(1.5),2),dropShadowAngle:0,dropShadowDistance:0,padding:1})},(t,e,i)=>{i.r(e),i.d(e,{default:()=>CubicTool});var n=i(9),o=i(3),s=i(6);const l=o.BezierTool.pointNearPoint;class InitializerIH extends s.InitializerInputHandler{get cubicTool(){return this.tool}constructor(t,e,i){super(t,!1,t.lineA,t.lineB,e,i)}move(t,e,i){super.move(t,e,i);let n=this.tool.lineB.x-this.tool.lineA.x,o=this.tool.lineB.y-this.tool.lineA.y;const s=Math.sqrt(n*n+o*o);n/=s,o/=s;const l=s*(2/3);this.cubicTool.controlA.set(this.tool.lineA.x+o*l,this.tool.lineA.y+-n*l),this.cubicTool.controlB.set(this.tool.lineB.x+o*l,this.tool.lineB.y+-n*l)}}class CubicTool extends o.BezierTool{constructor(t=10){super(t),this.lineA=new PIXI.Point,this.lineB=new PIXI.Point,this.controlA=new PIXI.Point,this.controlB=new PIXI.Point,this.bezier=new n.Bezier([0,0,0,0,0,0,0,0])}get handles(){return[this.lineA,this.controlA,this.controlB,this.lineB]}get bounds(){const t=new PIXI.Bounds;return t.addPoint(this.lineA),t.addPoint(this.lineB),t.addPoint(this.controlA),t.addPoint(this.controlB),t}get polygon(){return new PIXI.Polygon([this.lineA,this.lineB,this.controlA,this.controlB])}getSegments(t){return this.mode==o.ToolMode.NotPlaced?[]:(this.bezier.points=this.handles,this.bezier.update(),this.lastSegmentFetch=this.bezier.getLUT(t+2).map((t=>new PIXI.Point(t.x,t.y))))}drawHandles(t){this.mode!=o.ToolMode.NotPlaced&&(this.drawBoundingBox(t),t.beginFill(16755404).lineStyle(o.BezierTool.LINE_SIZE,16755404,1,.5).moveTo(this.lineA.x,this.lineA.y).lineTo(this.controlA.x,this.controlA.y).moveTo(this.lineB.x,this.lineB.y).lineTo(this.controlB.x,this.controlB.y).endFill(),super.drawSegmentLabel(t),this.drawHandle(t,16729156,this.lineA),this.drawHandle(t,16729156,this.lineB),this.drawHandle(t,11206468,this.controlA),this.drawHandle(t,11206468,this.controlB))}checkPointForDrag(t){return this.mode==o.ToolMode.NotPlaced?(this.setMode(o.ToolMode.Placing),new InitializerIH(this,(()=>this.setMode(o.ToolMode.Placed)),(()=>this.setMode(o.ToolMode.NotPlaced)))):l(t,this.lineA,o.BezierTool.HANDLE_RADIUS)?CubicTool.lockHandles?new s.MagnetPointInputHandler(this,this.lineA,this.controlA):new s.PointInputHandler(this,this.lineA):l(t,this.lineB,o.BezierTool.HANDLE_RADIUS)?CubicTool.lockHandles?new s.MagnetPointInputHandler(this,this.lineB,this.controlB):new s.PointInputHandler(this,this.lineB):l(t,this.controlA,o.BezierTool.HANDLE_RADIUS)?new s.PointInputHandler(this,this.controlA):l(t,this.controlB,o.BezierTool.HANDLE_RADIUS)?new s.PointInputHandler(this,this.controlB):this.polygon.contains(t.x,t.y)?new s.PointArrayInputHandler(this,t,this.handles):null}getTools(){return{cubiclock:{icon:"fas fa-lock",title:"df-curvy-walls.cubic_lock_handles",toggleable:!0,isActive:()=>CubicTool.lockHandles,onClick:t=>CubicTool.lockHandles=t}}}placeTool(t,e){this.lineA.set(e.l1[0]+t.x,e.l1[1]+t.y),this.lineB.set(e.l2[0]+t.x,e.l2[1]+t.y),this.controlA.set(e.c1[0]+t.x,e.c1[1]+t.y),this.controlB.set(e.c2[0]+t.x,e.c2[1]+t.y),this.setMode(o.ToolMode.Placed)}getData(){const t=this.lineCenter;return{l1:[this.lineA.x-t.x,this.lineA.y-t.y],l2:[this.lineB.x-t.x,this.lineB.y-t.y],c1:[this.controlA.x-t.x,this.controlA.y-t.y],c2:[this.controlB.x-t.x,this.controlB.y-t.y]}}}CubicTool.lockHandles=!0},(e,i,n)=>{n.r(i),n.d(i,{Bezier:()=>Bezier});const{abs:o,cos:s,sin:l,acos:r,atan2:a,sqrt:c,pow:h}=Math;function crt(t){return t<0?-h(-t,1/3):h(t,1/3)}const d=Math.PI,u=2*d,p=d/2,g=Number.MAX_SAFE_INTEGER||9007199254740991,y=Number.MIN_SAFE_INTEGER||-9007199254740991,m={x:0,y:0,z:0},f={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const i=e(t);let n=i.x*i.x+i.y*i.y;return void 0!==i.z&&(n+=i.z*i.z),c(n)},compute:function(t,e,i){if(0===t)return e[0].t=0,e[0];const n=e.length-1;if(1===t)return e[n].t=1,e[n];const o=1-t;let s=e;if(0===n)return e[0].t=t,e[0];if(1===n){const e={x:o*s[0].x+t*s[1].x,y:o*s[0].y+t*s[1].y,t};return i&&(e.z=o*s[0].z+t*s[1].z),e}if(n<4){let e,l,r,a=o*o,c=t*t,h=0;2===n?(s=[s[0],s[1],s[2],m],e=a,l=o*t*2,r=c):3===n&&(e=a*o,l=a*t*3,r=o*c*3,h=t*c);const d={x:e*s[0].x+l*s[1].x+r*s[2].x+h*s[3].x,y:e*s[0].y+l*s[1].y+r*s[2].y+h*s[3].y,t};return i&&(d.z=e*s[0].z+l*s[1].z+r*s[2].z+h*s[3].z),d}const l=JSON.parse(JSON.stringify(e));for(;l.length>1;){for(let e=0;e<l.length-1;e++)l[e]={x:l[e].x+(l[e+1].x-l[e].x)*t,y:l[e].y+(l[e+1].y-l[e].y)*t},void 0!==l[e].z&&(l[e]=l[e].z+(l[e+1].z-l[e].z)*t);l.splice(l.length-1,1)}return l[0].t=t,l[0]},computeWithRatios:function(t,e,i,n){const o=1-t,s=i,l=e;let r,a=s[0],c=s[1],h=s[2],d=s[3];return a*=o,c*=t,2===l.length?(r=a+c,{x:(a*l[0].x+c*l[1].x)/r,y:(a*l[0].y+c*l[1].y)/r,z:!!n&&(a*l[0].z+c*l[1].z)/r,t}):(a*=o,c*=2*o,h*=t*t,3===l.length?(r=a+c+h,{x:(a*l[0].x+c*l[1].x+h*l[2].x)/r,y:(a*l[0].y+c*l[1].y+h*l[2].y)/r,z:!!n&&(a*l[0].z+c*l[1].z+h*l[2].z)/r,t}):(a*=o,c*=1.5*o,h*=3*o,d*=t*t*t,4===l.length?(r=a+c+h+d,{x:(a*l[0].x+c*l[1].x+h*l[2].x+d*l[3].x)/r,y:(a*l[0].y+c*l[1].y+h*l[2].y+d*l[3].y)/r,z:!!n&&(a*l[0].z+c*l[1].z+h*l[2].z+d*l[3].z)/r,t}):void 0))},derive:function(t,e){const i=[];for(let n=t,o=n.length,s=o-1;o>1;o--,s--){const t=[];for(let i,o=0;o<s;o++)i={x:s*(n[o+1].x-n[o].x),y:s*(n[o+1].y-n[o].y)},e&&(i.z=s*(n[o+1].z-n[o].z)),t.push(i);i.push(t),n=t}return i},between:function(t,e,i){return e<=t&&t<=i||f.approximately(t,e)||f.approximately(t,i)},approximately:function(t,e,i){return o(t-e)<=(i||1e-6)},length:function(t){const e=f.Tvalues.length;let i=0;for(let n,o=0;o<e;o++)n=.5*f.Tvalues[o]+.5,i+=f.Cvalues[o]*f.arcfn(n,t);return.5*i},map:function(t,e,i,n,o){return n+(o-n)*((t-e)/(i-e))},lerp:function(t,e,i){const n={x:e.x+t*(i.x-e.x),y:e.y+t*(i.y-e.y)};return e.z&&i.z&&(n.z=e.z+t*(i.z-e.z)),n},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(f.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,i){const n=e.x-t.x,o=e.y-t.y,s=i.x-t.x,l=i.y-t.y;return a(n*l-o*s,n*s+o*l)},round:function(t,e){const i=""+t,n=i.indexOf(".");return parseFloat(i.substring(0,n+1+e))},dist:function(t,e){const i=t.x-e.x,n=t.y-e.y;return c(i*i+n*n)},closest:function(t,e){let i,n,o=h(2,63);return t.forEach((function(t,s){n=f.dist(e,t),n<o&&(o=n,i=s)})),{mdist:o,mpos:i}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=h(t,e)+h(1-t,e);return o((i-1)/i)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const i=h(1-t,e);return i/(h(t,e)+i)},lli8:function(t,e,i,n,o,s,l,r){const a=(t-i)*(s-r)-(e-n)*(o-l);return 0!=a&&{x:((t*n-e*i)*(o-l)-(t-i)*(o*r-s*l))/a,y:((t*n-e*i)*(s-r)-(e-n)*(o*r-s*l))/a}},lli4:function(t,e,i,n){const o=t.x,s=t.y,l=e.x,r=e.y,a=i.x,c=i.y,h=n.x,d=n.y;return f.lli8(o,s,l,r,a,c,h,d)},lli:function(t,e){return f.lli4(t,t.c,e,e.c)},makeline:function(t,e){const i=t.x,n=t.y,o=e.x,s=e.y,l=(o-i)/3,r=(s-n)/3;return new Bezier(i,n,i+l,n+r,i+2*l,n+2*r,o,s)},findbbox:function(t){let e=g,i=g,n=y,o=y;return t.forEach((function(t){const s=t.bbox();e>s.x.min&&(e=s.x.min),i>s.y.min&&(i=s.y.min),n<s.x.max&&(n=s.x.max),o<s.y.max&&(o=s.y.max)})),{x:{min:e,mid:(e+n)/2,max:n,size:n-e},y:{min:i,mid:(i+o)/2,max:o,size:o-i}}},shapeintersections:function(t,e,i,n,o){if(!f.bboxoverlap(e,n))return[];const s=[],l=[t.startcap,t.forward,t.back,t.endcap],r=[i.startcap,i.forward,i.back,i.endcap];return l.forEach((function(e){e.virtual||r.forEach((function(n){if(n.virtual)return;const l=e.intersects(n,o);l.length>0&&(l.c1=e,l.c2=n,l.s1=t,l.s2=i,s.push(l))}))})),s},makeshape:function(t,e,i){const n=e.points.length,o=t.points.length,s=f.makeline(e.points[n-1],t.points[0]),l=f.makeline(t.points[o-1],e.points[0]),r={startcap:s,forward:t,back:e,endcap:l,bbox:f.findbbox([s,t,e,l]),intersections:function(t){return f.shapeintersections(r,r.bbox,t,t.bbox,i)}};return r},getminmax:function(t,e,i){if(!i)return{min:0,max:0};let n,o,s=g,l=y;-1===i.indexOf(0)&&(i=[0].concat(i)),-1===i.indexOf(1)&&i.push(1);for(let r=0,a=i.length;r<a;r++)n=i[r],o=t.get(n),o[e]<s&&(s=o[e]),o[e]>l&&(l=o[e]);return{min:s,mid:(s+l)/2,max:l,size:l-s}},align:function(t,e){const i=e.p1.x,n=e.p1.y,o=-a(e.p2.y-n,e.p2.x-i);return t.map((function(t){return{x:(t.x-i)*s(o)-(t.y-n)*l(o),y:(t.x-i)*l(o)+(t.y-n)*s(o)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const i=t.length-1,n=f.align(t,e),reduce=function(t){return 0<=t&&t<=1};if(2===i){const t=n[0].y,e=n[1].y,i=n[2].y,o=t-2*e+i;if(0!==o){const n=-c(e*e-t*i),s=-t+e;return[-(n+s)/o,-(-n+s)/o].filter(reduce)}return e!==i&&0===o?[(2*e-i)/(2*e-2*i)].filter(reduce):[]}const o=n[0].y,l=n[1].y,a=n[2].y;let h=3*l-o-3*a+n[3].y,d=3*o-6*l+3*a,p=-3*o+3*l,g=o;if(f.approximately(h,0)){if(f.approximately(d,0))return f.approximately(p,0)?[]:[-g/p].filter(reduce);const t=c(p*p-4*d*g),e=2*d;return[(t-p)/e,(-p-t)/e].filter(reduce)}d/=h,p/=h,g/=h;const y=(3*p-d*d)/3,m=y/3,x=(2*d*d*d-9*d*p+27*g)/27,v=x/2,T=v*v+m*m*m;let _,P,w,C,M;if(T<0){const t=-y/3,e=c(t*t*t),i=-x/(2*e),n=r(i<-1?-1:i>1?1:i),o=2*crt(e);return w=o*s(n/3)-d/3,C=o*s((n+u)/3)-d/3,M=o*s((n+2*u)/3)-d/3,[w,C,M].filter(reduce)}if(0===T)return _=v<0?crt(-v):-crt(v),w=2*_-d/3,C=-_-d/3,[w,C].filter(reduce);{const t=c(T);return _=crt(-v+t),P=crt(v+t),[_-P-d/3].filter(reduce)}},droots:function(t){if(3===t.length){const e=t[0],i=t[1],n=t[2],o=e-2*i+n;if(0!==o){const t=-c(i*i-e*n),s=-e+i;return[-(t+s)/o,-(-t+s)/o]}return i!==n&&0===o?[(2*i-n)/(2*(i-n))]:[]}if(2===t.length){const e=t[0],i=t[1];return e!==i?[e/(e-i)]:[]}return[]},curvature:function(t,e,i,n,s){let l,r,a,d,u=0,p=0;const g=f.compute(t,e),y=f.compute(t,i),m=g.x*g.x+g.y*g.y;if(n?(l=c(h(g.y*y.z-y.y*g.z,2)+h(g.z*y.x-y.z*g.x,2)+h(g.x*y.y-y.x*g.y,2)),r=h(m+g.z*g.z,1.5)):(l=g.x*y.y-g.y*y.x,r=h(m,1.5)),0===l||0===r)return{k:0,r:0};if(u=l/r,p=r/l,!s){const s=f.curvature(t-.001,e,i,n,!0).k,l=f.curvature(t+.001,e,i,n,!0).k;d=(l-u+(u-s))/2,a=(o(l-u)+o(u-s))/2}return{k:u,r:p,dk:d,adk:a}},inflections:function(t){if(t.length<4)return[];const e=f.align(t,{p1:t[0],p2:t.slice(-1)[0]}),i=e[2].x*e[1].y,n=e[3].x*e[1].y,o=e[1].x*e[2].y,s=18*(-3*i+2*n+3*o-e[3].x*e[2].y),l=18*(3*i-n-3*o),r=18*(o-i);if(f.approximately(s,0)){if(!f.approximately(l,0)){let t=-r/l;if(0<=t&&t<=1)return[t]}return[]}const a=l*l-4*s*r,c=Math.sqrt(a),h=2*s;return f.approximately(h,0)?[]:[(c-l)/h,-(l+c)/h].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const i=["x","y"],n=i.length;for(let s,l,r,a,c=0;c<n;c++)if(s=i[c],l=t[s].mid,r=e[s].mid,a=(t[s].size+e[s].size)/2,o(l-r)>=a)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,i){const n=t.bbox(),o=e.bbox(),s=1e5,l=i||.5;if(n.x.size+n.y.size<l&&o.x.size+o.y.size<l)return[(s*(t._t1+t._t2)/2|0)/s+"/"+(s*(e._t1+e._t2)/2|0)/s];let r=t.split(.5),a=e.split(.5),c=[{left:r.left,right:a.left},{left:r.left,right:a.right},{left:r.right,right:a.right},{left:r.right,right:a.left}];c=c.filter((function(t){return f.bboxoverlap(t.left.bbox(),t.right.bbox())}));let h=[];return 0===c.length||(c.forEach((function(t){h=h.concat(f.pairiteration(t.left,t.right,l))})),h=h.filter((function(t,e){return h.indexOf(t)===e}))),h},getccenter:function(t,e,i){const n=e.x-t.x,o=e.y-t.y,r=i.x-e.x,c=i.y-e.y,h=n*s(p)-o*l(p),d=n*l(p)+o*s(p),g=r*s(p)-c*l(p),y=r*l(p)+c*s(p),m=(t.x+e.x)/2,x=(t.y+e.y)/2,v=(e.x+i.x)/2,T=(e.y+i.y)/2,_=m+h,P=x+d,w=v+g,C=T+y,M=f.lli8(m,x,_,P,v,T,w,C),I=f.dist(M,t);let b,z=a(t.y-M.y,t.x-M.x),B=a(e.y-M.y,e.x-M.x),A=a(i.y-M.y,i.x-M.x);return z<A?((z>B||B>A)&&(z+=u),z>A&&(b=A,A=z,z=b)):A<B&&B<z?(b=A,A=z,z=b):A+=u,M.s=z,M.e=A,M.r=I,M},numberSort:function(t,e){return t-e}};class PolyBezier{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return f.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),i=1;i<t.length;i++)f.expandbox(e,t[i].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(i){e.push(...i.offset(t))})),new PolyBezier(e)}}const{abs:x,min:v,max:T,cos:_,sin:P,acos:w,sqrt:C}=Math,M=Math.PI;class Bezier{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),i=!1;if("object"==typeof e[0]){i=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(i){void 0!==e[i]&&t.push(e[i])}))})),e=t}let n=!1;const o=e.length;if(i){if(i>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");n=!0}}else if(6!==o&&8!==o&&9!==o&&12!==o&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const s=this._3d=!n&&(9===o||12===o)||t&&t[0]&&void 0!==t[0].z,l=this.points=[];for(let t=0,i=s?3:2;t<o;t+=i){var r={x:e[t],y:e[t+1]};s&&(r.z=e[t+2]),l.push(r)}const a=this.order=l.length-1,c=this.dims=["x","y"];s&&c.push("z"),this.dimlen=c.length;const h=f.align(l,{p1:l[0],p2:l[a]});this._linear=!h.some((t=>x(t.y)>1e-4)),this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,i,n){if(void 0===n&&(n=.5),0===n)return new Bezier(e,e,i);if(1===n)return new Bezier(t,e,e);const o=Bezier.getABC(2,t,e,i,n);return new Bezier(t,o.A,i)}static cubicFromPoints(t,e,i,n,o){void 0===n&&(n=.5);const s=Bezier.getABC(3,t,e,i,n);void 0===o&&(o=f.dist(e,s.C));const l=o*(1-n)/n,r=f.dist(t,i),a=(i.x-t.x)/r,c=(i.y-t.y)/r,h=o*a,d=o*c,u=l*a,p=l*c,g=e.x-h,y=e.y-d,m=e.x+u,x=e.y+p,v=s.A,T=v.x+(g-v.x)/(1-n),_=v.y+(y-v.y)/(1-n),P=v.x+(m-v.x)/n,w=v.y+(x-v.y)/n,C={x:t.x+(T-t.x)/n,y:t.y+(_-t.y)/n},M={x:i.x+(P-i.x)/(1-n),y:i.y+(w-i.y)/(1-n)};return new Bezier(t,C,M,i)}static getUtils(){return f}getUtils(){return Bezier.getUtils()}static get PolyBezier(){return PolyBezier}valueOf(){return this.toString()}toString(){return f.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let i=1,n=t.length;i<n;i++)e.push(t[i].x),e.push(t[i].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=f.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=f.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return f.length(this.derivative.bind(this))}static getABC(t=2,e,i,n,o=.5){const s=f.projectionratio(o,t),l=1-s,r={x:s*e.x+l*n.x,y:s*e.y+l*n.y},a=f.abcratio(o,t);return{A:{x:i.x+(i.x-r.x)/a,y:i.y+(i.y-r.y)/a},B:i,C:r,S:e,E:n}}getABC(t,e){e=e||this.get(t);let i=this.points[0],n=this.points[this.order];return Bezier.getABC(this.order,i,e,n,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t--;for(let e,i,n=0;n<t;n++)i=n/(t-1),e=this.compute(i),e.t=i,this._lut.push(e);return this._lut}on(e,i){i=i||5;const n=this.getLUT(),o=[];for(let t,s=0,l=0;s<n.length;s++)t=n[s],f.dist(t,e)<i&&(o.push(t),l+=s/n.length);return!!o.length&&(t/=o.length)}project(t){const e=this.getLUT(),i=e.length-1,n=f.closest(e,t),o=n.mpos,s=(o-1)/i,l=(o+1)/i,r=.1/i;let a,c,h=n.mdist,d=s,u=d;for(h+=1;d<l+r;d+=r)a=this.compute(d),c=f.dist(t,a),c<h&&(h=c,u=d);return u=u<0?0:u>1?1:u,a=this.compute(u),a.t=u,a.d=h,a}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?f.computeWithRatios(t,this.points,this.ratios,this._3d):f.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],i=t.length;for(let n,o,s=1;s<i;s++)n=t[s],o=t[s-1],e[s]={x:(i-s)/i*n.x+s/i*o.x,y:(i-s)/i*n.y+s/i*o.y};return e[i]=t[i-1],new Bezier(e)}derivative(t){return f.compute(t,this.dpoints[0])}dderivative(t){return f.compute(t,this.dpoints[1])}align(){let t=this.points;return new Bezier(f.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return f.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return f.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),i=C(e.x*e.x+e.y*e.y);return{x:-e.y/i,y:e.x/i}}__normal3(t){const e=this.derivative(t),i=this.derivative(t+.01),n=C(e.x*e.x+e.y*e.y+e.z*e.z),o=C(i.x*i.x+i.y*i.y+i.z*i.z);e.x/=n,e.y/=n,e.z/=n,i.x/=o,i.y/=o,i.z/=o;const s={x:i.y*e.z-i.z*e.y,y:i.z*e.x-i.x*e.z,z:i.x*e.y-i.y*e.x},l=C(s.x*s.x+s.y*s.y+s.z*s.z);s.x/=l,s.y/=l,s.z/=l;const r=[s.x*s.x,s.x*s.y-s.z,s.x*s.z+s.y,s.x*s.y+s.z,s.y*s.y,s.y*s.z-s.x,s.x*s.z-s.y,s.y*s.z+s.x,s.z*s.z];return{x:r[0]*e.x+r[1]*e.y+r[2]*e.z,y:r[3]*e.x+r[4]*e.y+r[5]*e.z,z:r[6]*e.x+r[7]*e.y+r[8]*e.z}}hull(t){let e=this.points,i=[],n=[],o=0;for(n[o++]=e[0],n[o++]=e[1],n[o++]=e[2],3===this.order&&(n[o++]=e[3]);e.length>1;){i=[];for(let s,l=0,r=e.length-1;l<r;l++)s=f.lerp(t,e[l],e[l+1]),n[o++]=s,i.push(s);e=i}return n}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const i=this.hull(t),n={left:2===this.order?new Bezier([i[0],i[3],i[5]]):new Bezier([i[0],i[4],i[7],i[9]]),right:2===this.order?new Bezier([i[5],i[4],i[2]]):new Bezier([i[9],i[8],i[6],i[3]]),span:i};return n.left._t1=f.map(0,0,1,this._t1,this._t2),n.left._t2=f.map(t,0,1,this._t1,this._t2),n.right._t1=f.map(t,0,1,this._t1,this._t2),n.right._t2=f.map(1,0,1,this._t1,this._t2),e?(e=f.map(e,t,1,0,1),n.right.split(e).left):n}extrema(){const t={};let e=[];return this.dims.forEach(function(i){let mfn=function(t){return t[i]},n=this.dpoints[0].map(mfn);t[i]=f.droots(n),3===this.order&&(n=this.dpoints[1].map(mfn),t[i]=t[i].concat(f.droots(n))),t[i]=t[i].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[i].sort(f.numberSort))}.bind(this)),t.values=e.sort(f.numberSort).filter((function(t,i){return e.indexOf(t)===i})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(i){e[i]=f.getminmax(this,i,t[i])}.bind(this)),e}overlaps(t){const e=this.bbox(),i=t.bbox();return f.bboxoverlap(e,i)}offset(t,e){if(void 0!==e){const i=this.get(t),n=this.normal(t),o={c:i,n,x:i.x+n.x*e,y:i.y+n.y*e};return this._3d&&(o.z=i.z+n.z*e),o}if(this._linear){const e=this.normal(0),i=this.points.map((function(i){const n={x:i.x+t*e.x,y:i.y+t*e.y};return i.z&&e.z&&(n.z=i.z+t*e.z),n}));return[new Bezier(i)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=f.angle(this.points[0],this.points[3],this.points[1]),e=f.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let i=t.x*e.x+t.y*e.y;return this._3d&&(i+=t.z*e.z),x(w(i))<M/3}reduce(){let t,e,i=0,n=0,o=.01,s=[],l=[],r=this.extrema().values;for(-1===r.indexOf(0)&&(r=[0].concat(r)),-1===r.indexOf(1)&&r.push(1),i=r[0],t=1;t<r.length;t++)n=r[t],e=this.split(i,n),e._t1=i,e._t2=n,s.push(e),i=n;return s.forEach((function(t){for(i=0,n=0;n<=1;)for(n=i+o;n<=1.01;n+=o)if(e=t.split(i,n),!e.simple()){if(n-=o,x(i-n)<o)return[];e=t.split(i,n),e._t1=f.map(i,0,1,t._t1,t._t2),e._t2=f.map(n,0,1,t._t1,t._t2),l.push(e),i=n;break}i<1&&(e=t.split(i,1),e._t1=f.map(i,0,1,t._t1,t._t2),e._t2=t._t2,l.push(e))})),l}scale(t){const e=this.order;let i=!1;if("function"==typeof t&&(i=t),i&&2===e)return this.raise().scale(i);const n=this.clockwise,o=i?i(0):t,s=i?i(1):t,l=[this.offset(0,10),this.offset(1,10)],r=this.points,a=[],c=f.lli4(l[0],l[0].c,l[1],l[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const i=a[t*e]=f.copy(r[t*e]);i.x+=(t?s:o)*l[t].n.x,i.y+=(t?s:o)*l[t].n.y})),i?([0,1].forEach((function(o){if(2!==e||!o){var s=r[o+1],l={x:s.x-c.x,y:s.y-c.y},h=i?i((o+1)/e):t;i&&!n&&(h=-h);var d=C(l.x*l.x+l.y*l.y);l.x/=d,l.y/=d,a[o+1]={x:s.x+h*l.x,y:s.y+h*l.y}}})),new Bezier(a)):([0,1].forEach((t=>{if(2===e&&t)return;const i=a[t*e],n=this.derivative(t),o={x:i.x+n.x,y:i.y+n.y};a[t+1]=f.lli4(i,o,c,r[t+1])})),new Bezier(a))}outline(t,e,i,n){e=void 0===e?t:e;const o=this.reduce(),s=o.length,l=[];let r,a=[],c=0,h=this.length();const d=void 0!==i&&void 0!==n;function linearDistanceFunction(t,e,i,n,o){return function(s){const l=n/i,r=(n+o)/i,a=e-t;return f.map(s,0,1,t+l*a,t+r*a)}}o.forEach((function(o){const s=o.length();d?(l.push(o.scale(linearDistanceFunction(t,i,h,c,s))),a.push(o.scale(linearDistanceFunction(-e,-n,h,c,s)))):(l.push(o.scale(t)),a.push(o.scale(-e))),c+=s})),a=a.map((function(t){return r=t.points,r[3]?t.points=[r[3],r[2],r[1],r[0]]:t.points=[r[2],r[1],r[0]],t})).reverse();const u=l[0].points[0],p=l[s-1].points[l[s-1].points.length-1],g=a[s-1].points[a[s-1].points.length-1],y=a[0].points[0],m=f.makeline(g,u),x=f.makeline(p,y),v=[m].concat(l).concat([x]).concat(a);return new PolyBezier(v)}outlineshapes(t,e,i){e=e||t;const n=this.outline(t,e).curves,o=[];for(let t=1,e=n.length;t<e/2;t++){const s=f.makeshape(n[t],n[e-t],i);s.startcap.virtual=t>1,s.endcap.virtual=t<e/2-1,o.push(s)}return o}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof Bezier&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=v(t.p1.x,t.p2.x),i=v(t.p1.y,t.p2.y),n=T(t.p1.x,t.p2.x),o=T(t.p1.y,t.p2.y);return f.roots(this.points,t).filter((t=>{var s=this.get(t);return f.between(s.x,e,n)&&f.between(s.y,i,o)}))}selfintersects(t){const e=this.reduce(),i=e.length-2,n=[];for(let o,s,l,r=0;r<i;r++)s=e.slice(r,r+1),l=e.slice(r+2),o=this.curveintersects(s,l,t),n.push(...o);return n}curveintersects(t,e,i){const n=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&n.push({left:t,right:e})}))}));let o=[];return n.forEach((function(t){const e=f.pairiteration(t.left,t.right,i);e.length>0&&(o=o.concat(e))})),o}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,i,n){const o=(n-i)/4,s=this.get(i+o),l=this.get(n-o),r=f.dist(t,e),a=f.dist(t,s),c=f.dist(t,l);return x(a-r)+x(c-r)}_iterate(t,e){let i,n=0,o=1;do{i=0,o=1;let s,l,r,a,c,h=this.get(n),d=!1,u=!1,p=o,g=1;do{if(u=d,a=r,p=(n+o)/2,s=this.get(p),l=this.get(o),r=f.getccenter(h,s,l),r.interval={start:n,end:o},d=this._error(r,h,n,o)<=t,c=u&&!d,c||(g=o),d){if(o>=1){if(r.interval.end=g=1,a=r,o>1){let t={x:r.x+r.r*_(r.e),y:r.y+r.r*P(r.e)};r.e+=f.angle({x:r.x,y:r.y},t,this.get(1))}break}o+=(o-n)/2}else o=p}while(!c&&i++<100);if(i>=100)break;a=a||r,e.push(a),n=g}while(o<1);return e}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>QuadTool});var n=i(3),o=i(6),s=i(9);const l=n.BezierTool.pointNearPoint;class InitializerIH extends o.InitializerInputHandler{get quadTool(){return this.tool}constructor(t,e,i){super(t,!1,t.lineA,t.lineB,e,i)}move(t,e,i){super.move(t,e,i);const n=(this.tool.lineB.x+this.tool.lineA.x)/2,o=(this.tool.lineB.y+this.tool.lineA.y)/2;let s=-(this.tool.lineB.x-this.tool.lineA.x),l=this.tool.lineB.y-this.tool.lineA.y;l*=.25,s*=.25,this.quadTool.control.set(n+l,o+s)}}class QuadTool extends n.BezierTool{constructor(t=10){super(t),this.lineA=new PIXI.Point,this.lineB=new PIXI.Point,this.control=new PIXI.Point}get handles(){return[this.lineA,this.control,this.lineB]}get bounds(){const t=new PIXI.Bounds;return t.addPoint(this.lineA),t.addPoint(this.lineB),t.addPoint(this.control),t}get polygon(){return new PIXI.Polygon([this.lineA,this.lineB,this.control])}getSegments(t){return this.mode==n.ToolMode.NotPlaced?[]:(this.bezier=s.Bezier.quadraticFromPoints(this.lineA,this.control,this.lineB),this.lastSegmentFetch=this.bezier.getLUT(t+2).map((t=>new PIXI.Point(t.x,t.y))))}drawHandles(t){this.mode!=n.ToolMode.NotPlaced&&(this.drawBoundingBox(t),super.drawSegmentLabel(t),this.drawHandle(t,16729156,this.lineA),this.drawHandle(t,16729156,this.lineB),this.drawHandle(t,11206468,this.control))}checkPointForDrag(t){return this.mode==n.ToolMode.NotPlaced?(this.setMode(n.ToolMode.Placing),new InitializerIH(this,(()=>this.setMode(n.ToolMode.Placed)),(()=>this.setMode(n.ToolMode.NotPlaced)))):l(t,this.lineA,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineA):l(t,this.lineB,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.lineB):l(t,this.control,n.BezierTool.HANDLE_RADIUS)?new o.PointInputHandler(this,this.control):this.polygon.contains(t.x,t.y)?new o.PointArrayInputHandler(this,t,this.handles):null}getTools(){return{}}placeTool(t,e){this.lineA.set(e.l1[0]+t.x,e.l1[1]+t.y),this.lineB.set(e.l2[0]+t.x,e.l2[1]+t.y),this.control.set(e.c[0]+t.x,e.c[1]+t.y),this.setMode(n.ToolMode.Placed)}getData(){const t=this.lineCenter;return{l1:[this.lineA.x-t.x,this.lineA.y-t.y],l2:[this.lineB.x-t.x,this.lineB.y-t.y],c:[this.control.x-t.x,this.control.y-t.y]}}}},(t,e,i)=>{i.r(e),i.d(e,{default:()=>PointMapper});var n=i(2),o=i(9),s=i(3),l=i(6);const r=s.BezierTool.pointNearPoint;class PointMapper extends s.BezierTool{constructor(){super(...arguments),this.lineA=new PIXI.Point,this.lineB=new PIXI.Point,this.points=[]}get handles(){throw new Error("Method not implemented.")}get bounds(){const t=new PIXI.Bounds;return this.points.forEach((e=>t.addPoint(e))),t}drawHandles(t){switch(this.drawBoundingBox(t),n.CurvyWallToolManager.instance.mode){case n.Mode.Quad:if(this.points.length<3)break;const e=o.Bezier.quadraticFromPoints(this.points[0],this.points[1],this.points[2]).getLUT().map((t=>new PIXI.Point(t.x,t.y)));t.beginFill(0,0).lineStyle(6,16755404,1,.5),t.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++)t.lineTo(e[i].x,e[i].y);t.endFill();break;case n.Mode.Circ:if(this.points.length<2)break;const i=this._calculateCircle();t.beginFill(0,0).lineStyle(6,16755404,1,.5).drawEllipse(i.x,i.y,i.w,i.h).endFill();break;case n.Mode.Rect:if(0==this.points.length)break;const s=this.bounds;t.beginFill(0,0).lineStyle(6,16755404,1,.5).drawRect(s.minX,s.minY,s.maxX-s.minX,s.maxY-s.minY).endFill()}const e=[4521898,16729156,4474111,14501085,14540100];this.points.forEach(((i,n)=>this.drawHandle(t,e[n],i)))}checkPointForClick(t,e){const i=new l.PointInputHandler(this,t),o=i.shouldSnap(e);if(e.data.originalEvent.ctrlKey){const e=this.points.findIndex((e=>r(t,e,s.BezierTool.HANDLE_RADIUS)));return!(e<0)&&(this.points.splice(e,1),!0)}if(this.points.find((e=>r(t,e,s.BezierTool.HANDLE_RADIUS))))return!1;switch(n.CurvyWallToolManager.instance.mode){case n.Mode.Quad:return 3!=this.points.length&&(this.points.push(i.getWallEndPoint(t,o)),!0);case n.Mode.Circ:case n.Mode.Rect:return 4!=this.points.length&&(this.points.push(i.getWallEndPoint(t,o)),!0)}return!1}checkPointForDrag(t){const e=this.points.find((e=>r(t,e,s.BezierTool.HANDLE_RADIUS)));return e?new l.PointInputHandler(this,e):null}getTooltipMessage(){switch(n.CurvyWallToolManager.instance.mode){case n.Mode.Quad:return"df-curvy-walls.pointmap_quad";case n.Mode.Circ:return"df-curvy-walls.pointmap_circ";case n.Mode.Rect:return"df-curvy-walls.pointmap_rect"}return""}hasEnoughData(){switch(n.CurvyWallToolManager.instance.mode){case n.Mode.Quad:return 3==this.points.length;case n.Mode.Circ:case n.Mode.Rect:return this.points.length>=2}return!1}bindData(t){switch(n.CurvyWallToolManager.instance.mode){case n.Mode.Quad:t.lineA.copyFrom(this.points[0]),t.lineB.copyFrom(this.points[2]),t.control.copyFrom(this.points[1]);break;case n.Mode.Circ:const e=this._calculateCircle();t.lineA.set(e.x-e.w,e.y-e.h),t.lineB.set(e.x+e.w,e.y+e.h);break;case n.Mode.Rect:const i=this.bounds;t.lineA.set(i.minX,i.minY),t.lineB.set(i.maxX,i.maxY)}}_calculateCircle(){const t={x:0,y:0,w:0,h:0};if(2==this.points.length){t.x=this.points[0].x,t.y=this.points[0].y;const e=Math.sqrt(Math.pow(this.points[1].x-t.x,2)+Math.pow(this.points[1].y-t.y,2));t.w=e,t.h=e}else if(3==this.points.length){const e=function generateCircle(t,e,i){return isPerpendicular(t,e,i)?isPerpendicular(t,i,e)?isPerpendicular(e,t,i)?isPerpendicular(e,i,t)?isPerpendicular(i,e,t)?isPerpendicular(i,t,e)?{center:null,radius:-1}:calcCircle(i,t,e):calcCircle(i,e,t):calcCircle(e,i,t):calcCircle(e,t,i):calcCircle(t,i,e):calcCircle(t,e,i)}(this.points[0],this.points[1],this.points[2]);t.x=e.center.x,t.y=e.center.y,t.w=e.radius,t.h=e.radius}else if(4==this.points.length){const e=this.bounds;t.x=(e.minX+e.maxX)/2,t.y=(e.minY+e.maxY)/2,t.w=(e.maxX-e.minX)/2,t.h=(e.maxY-e.minY)/2}return t}getSegments(t){throw new Error("Method not implemented.")}placeTool(t,e){throw new Error("Method not implemented.")}getData(){throw new Error("Method not implemented.")}getTools(){throw new Error("Method not implemented.")}}function isPerpendicular(t,e,i){const n=e.y-t.y,o=e.x-t.x,s=i.y-e.y,l=i.x-e.x;return!(Math.abs(o)<=1e-9&&Math.abs(s)<=1e-9)&&(Math.abs(n)<=1e-7||(Math.abs(s)<=1e-7||(Math.abs(o)<=1e-9||Math.abs(l)<=1e-9)))}function calcCircle(t,e,i){const n=e.y-t.y,o=e.x-t.x,s=i.y-e.y,l=i.x-e.x,r=new PIXI.Point;let a=0;if(Math.abs(o)<=1e-9&&Math.abs(s)<=1e-9)return r.x=.5*(e.x+i.x),r.y=.5*(t.y+e.y),a=Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2)),{center:r,radius:a};const c=n/o,h=s/l;return Math.abs(c-h)<=1e-9?{center:r,radius:-1}:(r.x=(c*h*(t.y-i.y)+h*(t.x+e.x)-c*(e.x+i.x))/(2*(h-c)),r.y=-1*(r.x-(t.x+e.x)/2)/c+(t.y+e.y)/2,a=Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2)),{center:r,radius:a})}}],i={};function __webpack_require__(t){var n=i[t];if(void 0!==n)return n.exports;var o=i[t]={exports:{}};return e[t](o,o.exports,__webpack_require__),o.exports}__webpack_require__.d=(t,e)=>{for(var i in e)__webpack_require__.o(e,i)&&!__webpack_require__.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};(()=>{__webpack_require__.r(n);var t=__webpack_require__(1),e=__webpack_require__(2),i=__webpack_require__(4),o=__webpack_require__(3);const s=new t.CurvyWallsToolBar;i.default.init("df-curvy-walls"),Hooks.once("init",(function(){i.default.register(t.CurvyWallsToolBar.PREF_PRESERVE,{scope:"world",type:Boolean,config:!0,default:!0,name:"df-curvy-walls.SettingPreserve_Name",hint:"df-curvy-walls.SettingPreserve_Hint"}),i.default.register(e.CurvyWallToolManager.PREF_DROP_KEY,{name:"df-curvy-walls.SettingDropKey_Name",hint:"df-curvy-walls.SettingDropKey_Hint",config:!0,scope:"world",choices:{alt:"df-curvy-walls.SettingDropKey_OptionAlt",ctrl:"df-curvy-walls.SettingDropKey_OptionCtrl"},default:"alt",type:String}),i.default.register(o.BezierTool.PREF_SMALL_HANDLES,{name:"df-curvy-walls.SettingSmallHandlesName",hint:"df-curvy-walls.SettingSmallHandlesHint",config:!0,scope:"world",type:Boolean,default:!1}),game.keybindings.register(i.default.MOD_NAME,"applyTool",{name:"df-curvy-walls.apply",editable:[{key:"Enter"}],onDown:()=>{e.CurvyWallToolManager.instance.apply()}}),game.keybindings.register(i.default.MOD_NAME,"cancelTool",{name:"df-curvy-walls.cancel",editable:[{key:"Delete"}],onDown:()=>e.CurvyWallToolManager.instance.clearTool()}),game.keybindings.register(i.default.MOD_NAME,"incrementSegments",{name:"df-curvy-walls.increment",editable:[{key:"Equal"}],repeat:!0,onDown:()=>{e.CurvyWallToolManager.instance.segments++}}),game.keybindings.register(i.default.MOD_NAME,"decrementSegments",{name:"df-curvy-walls.decrement",editable:[{key:"Minus"}],repeat:!0,onDown:()=>{e.CurvyWallToolManager.instance.segments--}})})),Hooks.once("ready",(function(){var t;if(!(null===(t=game.modules.get("lib-wrapper"))||void 0===t?void 0:t.active))return console.error("Missing libWrapper module dependency"),void(game.user.isGM&&ui.notifications.error(game.i18n.localize("df-curvy-walls.errorLibWrapperMissing")));canvas.walls.bezier=e.CurvyWallToolManager.instance,e.CurvyWallToolManager.instance.patchWallsLayer()})),Hooks.on("renderSceneControls",(async t=>{var i;(null===(i=game.modules.get("lib-wrapper"))||void 0===i?void 0:i.active)&&game.user.isGM&&("walls"===t.activeControl?(s.render(!0),e.CurvyWallToolManager.instance.mode!=e.Mode.None&&e.CurvyWallToolManager.instance.render()):await s.close())}))})()})();
//# sourceMappingURL=main.js.map